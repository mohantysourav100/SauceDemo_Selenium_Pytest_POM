stages:
  - install
  - test
  - report

variables:
  VENV_DIR: "tmp_venv"
  ALLURE_RESULTS: "allure-results"
  REPORTS_DIR: "reports"

default:
  tags:
    - windows
  before_script:
    # Always use PowerShell on Windows GitLab runners
    - powershell -Command "if (Test-Path '$env:VENV_DIR') { Remove-Item -Recurse -Force '$env:VENV_DIR' }"
    - python -m venv $env:VENV_DIR
    - powershell -Command "& '$env:VENV_DIR\Scripts\Activate.ps1'"
    - python -m pip install --upgrade pip setuptools wheel
    - pip install -r requirements.txt

install_dependencies:
  stage: install
  script:
    - echo "✅ Dependencies installed successfully."
  artifacts:
    paths:
      - tmp_venv/
    expire_in: 1 week

chrome_tests:
  stage: test
  script:
    - powershell -Command "& '$env:VENV_DIR\Scripts\Activate.ps1'"
    - pytest -n 2 --browser_name=chrome -v -s ^
        --html="$env:REPORTS_DIR\chrome_report.html" --self-contained-html ^
        --alluredir="$env:ALLURE_RESULTS" --capture=tee-sys
  artifacts:
    when: always
    paths:
      - reports/
      - allure-results/

firefox_tests:
  stage: test
  script:
    - powershell -Command "& '$env:VENV_DIR\Scripts\Activate.ps1'"
    - pytest -n 2 --browser_name=firefox -v -s ^
        --html="$env:REPORTS_DIR\firefox_report.html" --self-contained-html ^
        --alluredir="$env:ALLURE_RESULTS" --capture=tee-sys
  artifacts:
    when: always
    paths:
      - reports/
      - allure-results/

edge_tests:
  stage: test
  script:
    - powershell -Command "& '$env:VENV_DIR\Scripts\Activate.ps1'"
    - pytest -n 2 --browser_name=edge -v -s ^
        --html="$env:REPORTS_DIR\edge_report.html" --self-contained-html ^
        --alluredir="$env:ALLURE_RESULTS" --capture=tee-sys
  artifacts:
    when: always
    paths:
      - reports/
      - allure-results/

generate_allure_report:
  stage: report
  script:
    - powershell -Command "& '$env:VENV_DIR\Scripts\Activate.ps1'"
    - allure generate $env:ALLURE_RESULTS --clean -o allure-report
  artifacts:
    when: always
    paths:
      - allure-report/

publish_html_reports:
  stage: report
  script:
    - echo "✅ HTML Reports ready in reports/ folder"
  artifacts:
    when: always
    paths:
      - reports/